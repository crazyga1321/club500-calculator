<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CLUB500 — Калькулятор (TV-style график + темы)</title>

<style>
  :root{
    --bg:#0b0f1a;
    --card:#0f1724;
    --accent:#7c3aed;
    --muted:#94a3b8;
    --glass: rgba(255,255,255,0.03);
    --success:#10b981;
    --text:#e6eef8;
    --panel-shadow: 0 6px 28px rgba(2,6,23,0.6);
  }

  /* Light theme variables (will be applied when .light on body) */
  :root.light{
    --bg:#f6f8fb;
    --card:#ffffff;
    --accent:#5b21b6;
    --muted:#6b7280;
    --glass: rgba(2,6,23,0.02);
    --success:#059669;
    --text:#0b1220;
    --panel-shadow: 0 6px 18px rgba(12,18,28,0.06);
  }

  /* Base layout */
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071024);color:var(--text)}
  .wrap{max-width:1100px;margin:26px auto;padding:20px}
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#5b21b6,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--panel-shadow);border:1px solid rgba(255,255,255,0.02)}
  .inputs label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
  .inputs input[type="number"], .inputs select{width:100%;padding:8px 10px;margin-top:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:var(--glass);color:var(--text)}
  .row{display:flex;gap:10px}
  .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px dashed rgba(0,0,0,0.04)}
  th{font-size:13px;color: var(--text);background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
  td.small{font-size:13px;color:var(--muted)}
  .result{font-size:20px;font-weight:700;color:var(--success)}
  .chartWrap{height:300px;margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(124,58,237,0.03), rgba(6,182,212,0.01));display:flex;flex-direction:column;gap:8px}
  .chartTop{display:flex;justify-content:space-between;align-items:center}
  .chartArea{flex:1;border-radius:8px;overflow:hidden;background:transparent;display:flex;align-items:center;justify-content:center}
  .controls{display:flex;gap:8px;align-items:center}
  .styleBtn{padding:6px 9px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .styleBtn.active{box-shadow:0 6px 16px rgba(0,0,0,0.25);transform:translateY(-2px)}
  .themeToggle{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);cursor:pointer}

  .fake-input{
    width:100%;
    padding:8px 10px;
    margin-top:6px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.06);
    background:var(--glass);
    color:var(--text);
    font-size:14px;
  }

  @media(max-width:1020px){ .grid{grid-template-columns:1fr 360px} }
  @media(max-width:900px){ .grid{grid-template-columns:1fr} .card{padding:12px} .chartWrap{height:260px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">CL</div>
    <div style="flex:1">
      <h1>CLUB500 — Калькулятор роста депозита</h1>
      <p class="lead">Рост → затем абонплата в конце года (если после роста ≥ порог). Пресеты стиля графика: 1 (фиол-голубой), 2 (зелёный), 4 (красно-фиолетовый).</p>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
      <div style="display:flex;gap:8px">
        <button class="themeToggle" id="themeAuto">Auto</button>
        <button class="themeToggle" id="themeLight">Light</button>
        <button class="themeToggle" id="themeDark">Dark</button>
      </div>
      <div style="font-size:12px;color:var(--muted)">Тема: <span id="themeLabel">auto</span></div>
    </div>
  </header>

  <div class="grid">
    <!-- left -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Параметры расчёта</div>
          <div style="font-weight:700;margin-top:4px">Настрой параметры и покажи партнёрам</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="shareBtn">Скопировать ссылку</button>
        </div>
      </div>

      <div class="inputs" style="margin-top:12px">
        <label>Начальный депозит ($)
          <input id="S0" type="number" value="4000" min="0" step="1">
        </label>

        <label>Годовая доходность (%) — например 200 = +200%
          <input id="r" type="number" value="200" step="1" min="0">
        </label>

        <label>Лет
          <select id="years">
            <option value="3" selected>3</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </label>

        <!-- partner readonly display (fake inputs) + hidden values used by calc -->
        <label>Абонплата (% от баланса конца года)
          <div class="fake-input" id="displayFee">10%</div>
          <input id="feePct" type="hidden" value="10">
        </label>

        <label>Порог для взимания абонплаты ($)
          <div class="fake-input" id="displayThreshold">5000$</div>
          <input id="threshold" type="hidden" value="5000">
        </label>

        <label>Потолок абонплаты ($)
          <div class="fake-input" id="displayCap">5000$</div>
          <input id="cap" type="hidden" value="5000">
        </label>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="calcBtn">Посчитать</button>
          <button id="resetBtn" class="btn ghost">Сброс</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="muted">Детализация по годам</div>
        <table id="table">
          <thead><tr><th>Год</th><th>Начало ($)</th><th>После роста ($)</th><th>Абонплата ($)</th><th>Итог ($)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- right -->
    <div>
      <div class="card">
        <div class="chartTop">
          <div>
            <div class="muted">Краткая сводка</div>
            <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
              <div>
                <div class="muted">Итоговый капитал</div>
                <div id="final" class="result">$0.00</div>
              </div>
              <div>
                <div class="muted">Общий снятый fee</div>
                <div id="totalFees" style="font-weight:700">$0.00</div>
              </div>
            </div>
          </div>

          <div class="controls">
            <div style="font-size:13px;color:var(--muted);margin-right:6px">Style</div>
            <button class="styleBtn" data-style="1" id="style1">1</button>
            <button class="styleBtn" data-style="2" id="style2">2</button>
            <button class="styleBtn" data-style="4" id="style4">4</button>
          </div>
        </div>

        <div class="chartWrap">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">График (TV-style)</div>
            <div class="muted" id="chartInfo">—</div>
          </div>
          <div class="chartArea" id="chartArea">
            <!-- SVG injected here -->
            <svg id="tvSvg" width="100%" height="100%" viewBox="0 0 800 300" preserveAspectRatio="none"></svg>
          </div>
        </div>

        <div style="margin-top:12px" class="muted">Совет: переключи стиль графика в правом верхнем углу.</div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="muted">Экспорт</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="csvBtn" class="btn" style="background:#06b6d4">Скачать CSV</button>
          <button id="shareBtn2" class="btn" style="background:#7c3aed">Скопировать ссылку</button>
        </div>
      </div>
    </div>
  </div>

  <footer style="margin-top:18px;text-align:center;color:var(--muted);font-size:13px">
    CLUB500 • Логика: рост → проверка порога → min(after*fee, cap)
  </footer>
</div>

<script>
/* ======= Utilities & safe parsing ======= */
const $ = id => document.getElementById(id);
const parseNumSafe = v => { const n = parseFloat(v); return isFinite(n) ? n : 0; };

/* ======= Compute logic (robust) ======= */
function compute(params){
  let S = parseNumSafe(params.S0);
  const r = parseNumSafe(params.r);
  const years = Math.max(1, Math.floor(parseNumSafe(params.years)));
  const feePct = parseNumSafe(params.feePct)/100;
  const threshold = parseNumSafe(params.threshold);
  const cap = parseNumSafe(params.cap);

  const rows = [];
  let totalFees = 0;

  for(let i=1;i<=years;i++){
    const start = S;
    const after = start * (1 + r/100);
    let fee = 0;
    if(after >= threshold){
      fee = Math.min(after * feePct, cap);
    }
    const end = after - fee;
    rows.push({year:i, start, after, fee, end});
    totalFees += fee;
    S = end;
  }
  return {rows, final: S, totalFees};
}

/* ======= UI helpers ======= */
function money(n){ return '$' + Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function clearTable(){ $('table').querySelector('tbody').innerHTML = ''; }
function drawTable(rows){
  const tbody = document.querySelector('#table tbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="small">${r.year}</td>
                    <td>${money(r.start)}</td>
                    <td>${money(r.after)}</td>
                    <td>${money(r.fee)}</td>
                    <td style="font-weight:700">${money(r.end)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ======= Chart drawing (TV-like line with gradient + glow) ======= */
/* Catmull-Rom to Bezier smoothing to get pleasing curve */
function catmullRom2bezier(points){
  // points: [[x,y],...]
  const d = [];
  for(let i=0;i<points.length-1;i++){
    const p0 = points[i-1] || points[i];
    const p1 = points[i];
    const p2 = points[i+1];
    const p3 = points[i+2] || p2;
    const bp1x = p1[0] + (p2[0]-p0[0])/6;
    const bp1y = p1[1] + (p2[1]-p0[1])/6;
    const bp2x = p2[0] - (p3[0]-p1[0])/6;
    const bp2y = p2[1] - (p3[1]-p1[1])/6;
    d.push([bp1x,bp1y,bp2x,bp2y,p2[0],p2[1]]);
  }
  return d;
}

function drawTVChart(rows, styleId){
  const svg = document.getElementById('tvSvg');
  const rect = svg.getBoundingClientRect();
  // responsive viewBox width: use dynamic width based on container; but maintain viewBox of 800x300
  const w = 800, h = 300, pad = 36;
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

  // if no rows, clear and return
  if(!rows || rows.length===0){ svg.innerHTML = ''; return; }

  const values = rows.map(r=>r.end);
  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = (max - min) || 1;

  // create points
  const pts = rows.map((r,i)=>{
    const x = pad + (i/(rows.length-1 || 1))*(w - pad*2);
    const y = h - pad - ((r.end - min)/range)*(h - pad*2);
    return [x,y];
  });

  // create smoothed path
  let pathD = `M ${pts[0][0]} ${pts[0][1]}`;
  if(pts.length>1){
    const beziers = catmullRom2bezier(pts);
    beziers.forEach((b,i)=>{
      pathD += ` C ${b[0]} ${b[1]}, ${b[2]} ${b[3]}, ${b[4]} ${b[5]}`;
    });
  }

  // build SVG: grid + gradient defs + glow + path + dots + labels
  const defs = `
    <defs>
      <linearGradient id="g${styleId}" x1="0" x2="1" y1="0" y2="0">
        ${ styleId === 1 ? `
          <stop offset="0%" stop-color="#7c3aed" stop-opacity="1"/>
          <stop offset="100%" stop-color="#06b6d4" stop-opacity="1"/>` :
        styleId === 2 ? `
          <stop offset="0%" stop-color="#10b981" stop-opacity="1"/>
          <stop offset="100%" stop-color="#06b6d4" stop-opacity="1"/>` :
        /* styleId 4 */
          `<stop offset="0%" stop-color="#ef4444" stop-opacity="1"/>
           <stop offset="100%" stop-color="#7c3aed" stop-opacity="1"/>`
        }
      </linearGradient>

      <linearGradient id="fill${styleId}" x1="0" x2="0" y1="0" y2="1">
        ${ styleId === 1 ? `
          <stop offset="0%" stop-color="#7c3aed" stop-opacity="0.18"/>
          <stop offset="100%" stop-color="#06b6d4" stop-opacity="0.02"/>` :
        styleId === 2 ? `
          <stop offset="0%" stop-color="#10b981" stop-opacity="0.16"/>
          <stop offset="100%" stop-color="#06b6d4" stop-opacity="0.02"/>` :
          `<stop offset="0%" stop-color="#ef4444" stop-opacity="0.16"/>
           <stop offset="100%" stop-color="#7c3aed" stop-opacity="0.02"/>`
        }
      </linearGradient>

      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
        <feMerge>
          <feMergeNode in="coloredBlur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>`;

  // grid lines (horizontal)
  let grid = '';
  const gridSteps = 4;
  for(let i=0;i<=gridSteps;i++){
    const gy = pad + i*((h - pad*2)/gridSteps);
    grid += `<line x1="${pad}" x2="${w-pad}" y1="${gy}" y2="${gy}" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>`;
  }

  // area path for fill (close to bottom)
  const areaD = pathD + ` L ${pts[pts.length-1][0]} ${h-pad} L ${pts[0][0]} ${h-pad} Z`;

  // points dots and small labels for years on x axis
  let dots = '', xlabels = '', ylabels = '';
  pts.forEach((p,i)=>{
    dots += `<circle cx="${p[0]}" cy="${p[1]}" r="${i===pts.length-1?4:3}" fill="#fff" opacity="${i===pts.length-1?1:0.9}"/>`;
    const labelX = p[0];
    const year = rows[i].year;
    xlabels += `<text x="${labelX}" y="${h - pad + 18}" font-size="11" fill="var(--muted)" text-anchor="middle">${year}</text>`;
  });

  // y-axis labels (3 labels)
  for(let i=0;i<=3;i++){
    const val = (max - (i*(range/3)));
    const gy = pad + (i*( (h - pad*2)/3 ));
    ylabels += `<text x="${10}" y="${gy+4}" font-size="11" fill="var(--muted)">${money(val)}</text>`;
  }

  // assemble svg innerHTML
  svg.innerHTML =
    defs +
    `<g transform=""><rect x="0" y="0" width="${w}" height="${h}" fill="transparent"/></g>
     <g class="grid">${grid}</g>
     <g class="ylabels">${ylabels}</g>
     <g class="xlabels">${xlabels}</g>
     <g class="area">
       <path d="${areaD}" fill="url(#fill${styleId})" opacity="0.9"></path>
     </g>
     <g class="line" filter="url(#glow)">
       <path d="${pathD}" fill="none" stroke="url(#g${styleId})" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"></path>
     </g>
     <g class="dots">${dots}</g>`;

  // update chart info summary
  const last = rows[rows.length-1];
  $('chartInfo').innerText = `Итог: ${money(last.end)}`;
}

/* ======= Main recalc & events ======= */
function recalc(){
  const params = {
    S0: $('S0').value,
    r: $('r').value,
    years: $('years').value,
    feePct: $('feePct').value,
    threshold: $('threshold').value,
    cap: $('cap').value
  };
  const res = compute(params);
  drawTable(res.rows);
  $('final').innerText = money(res.final);
  $('totalFees').innerText = money(res.totalFees);

  // draw TV chart with current style
  drawTVChart(res.rows, currentStyle);
  return res;
}

/* ======= Style & Theme controls ======= */
let currentStyle = 1;
const styleButtons = Array.from(document.querySelectorAll('.styleBtn'));
styleButtons.forEach(b=>{
  b.addEventListener('click', ()=> {
    styleButtons.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentStyle = Number(b.dataset.style);
    recalc();
  });
});
// set default active
$('style1').classList.add('active');

// Theme handling
const themeLabel = $('themeLabel');
function applyTheme(mode){
  if(mode === 'auto'){
    document.body.classList.remove('light');
    // detect system
    const prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme:light)').matches;
    if(prefers) document.body.classList.add('light');
    themeLabel.innerText = 'auto';
  } else if(mode === 'light'){
    document.body.classList.add('light');
    themeLabel.innerText = 'light';
  } else {
    document.body.classList.remove('light');
    themeLabel.innerText = 'dark';
  }
}
$('themeAuto').addEventListener('click', ()=> applyTheme('auto'));
$('themeLight').addEventListener('click', ()=> applyTheme('light'));
$('themeDark').addEventListener('click', ()=> applyTheme('dark'));
applyTheme('auto'); // initial

/* ======= Events & CSV & share ======= */
$('calcBtn').addEventListener('click', recalc);
$('resetBtn').addEventListener('click', ()=> {
  $('S0').value = 4000;
  $('r').value = 200;
  $('years').value = 3;
  // hidden partner values remain same; redraw
  recalc();
});

$('csvBtn').addEventListener('click', ()=>{
  const r = recalc();
  let csv = 'Год,Начало,После роста,Абонплата,Итог\n';
  r.rows.forEach(row => csv += `${row.year},${row.start},${row.after},${row.fee},${row.end}\n`);
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'club500.csv'; a.click();
  URL.revokeObjectURL(url);
});

$('shareBtn').addEventListener('click', ()=> {
  const params = new URLSearchParams({
    S0:$('S0').value, r:$('r').value, years:$('years').value,
    feePct:$('feePct').value, threshold:$('threshold').value, cap:$('cap').value
  });
  const link = location.href.split('?')[0] + '?' + params.toString();
  navigator.clipboard?.writeText(link).then(()=> alert('Ссылка скопирована в буфер обмена'));
});
$('shareBtn2').addEventListener('click', ()=> $('shareBtn').click());

/* ======= load from url params on start ======= */
(function loadFromParams(){
  const p = new URLSearchParams(location.search);
  if(p.has('S0')) $('S0').value = p.get('S0');
  if(p.has('r')) $('r').value = p.get('r');
  if(p.has('years')) $('years').value = p.get('years');
  if(p.has('feePct')) $('feePct').value = p.get('feePct');
  if(p.has('threshold')) $('threshold').value = p.get('threshold');
  if(p.has('cap')) $('cap').value = p.get('cap');

  // update display fake-inputs (format nicely)
  $('displayFee').innerText = (parseNumSafe($('feePct').value) || 0) + '%';
  $('displayThreshold').innerText = (parseNumSafe($('threshold').value) || 0) + '$';
  $('displayCap').innerText = (parseNumSafe($('cap').value) || 0) + '$';

  recalc();
})();

/* ======= make chart responsive on resize (redraw) ======= */
let resizeTimer;
window.addEventListener('resize', ()=> {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=> recalc(), 180);
});
</script>
</body>
</html>
