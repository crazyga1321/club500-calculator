<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CLUB500 — Калькулятор + Сводка сделок</title>
<style>
  :root{
    --bg:#0b0f1a; --card:#0f1724; --accent:#10b981; --muted:#94a3b8; --glass:rgba(255,255,255,0.03); --text:#e6eef8;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071024);color:var(--text);}
  .wrap{max-width:1100px;margin:26px auto;padding:20px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#10b981,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{margin:0;font-size:18px}
  .lead{color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tabBtn{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer;font-weight:600}
  .tabBtn.active{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(16,185,129,0.12)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  .card{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 6px 24px rgba(2,6,23,0.6)}
  label{display:block;color:var(--muted);font-size:13px;margin-top:12px}
  input[type="number"], select, input[type="text"]{width:100%;padding:8px;border-radius:8px;margin-top:6px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:var(--text)}
  .row{display:flex;gap:10px;margin-top:12px}
  .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px dashed rgba(255,255,255,0.03)}
  th{font-size:13px;color:#fff;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
  td.small{font-size:13px;color:var(--muted)}
  .result{font-size:20px;font-weight:700;color:var(--accent)}
  .chartWrap{height:320px;margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(16,185,129,0.04), rgba(6,182,212,0.02));display:flex;flex-direction:column}
  .chartArea{flex:1;border-radius:8px;overflow:hidden}
  .fake-input{width:100%;padding:8px 10px;margin-top:6px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .scanBadge{position:relative;display:inline-block;padding:12px 22px;border-radius:12px;background:rgba(16,185,129,0.12);color:#10b981;font-weight:700;border:1px solid rgba(16,185,129,0.45);overflow:hidden;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 0 14px rgba(16,185,129,0.35)}
  .scanBadge::after{content:"";position:absolute;top:0;left:-120%;width:50%;height:100%;background:linear-gradient(120deg,transparent,rgba(16,185,129,0.4),transparent);animation:scanMove 2.6s infinite}
  @keyframes scanMove{0%{left:-120%}50%{left:120%}100%{left:-120%}}
  /* TAG (style B: dark with green border) */
  .tagWrap{display:flex;align-items:center;gap:6px;justify-content:center}
  .tagDisplay{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.12);border:1px solid rgba(16,185,129,0.45);color:#10b981;font-weight:700}
  .tagDisplay .remove{cursor:pointer;padding:2px 6px;border-radius:6px;background:transparent;color:#10b981;border:0;font-weight:700}
  .assetEntry{border:0;background:transparent;color:var(--text);outline:none;padding:6px}
  .deals-input{width:100%;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text)}
  .small-muted{font-size:12px;color:var(--muted)}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} .chartWrap{height:260px} }
</style>
</head>
<body>
<div class="wrap">
  <header style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
    <div class="logo">CL</div>
    <div style="flex:1">
      <h1>CLUB500 — Калькулятор роста депозита</h1>
      <div class="lead">Рост → затем абонплата. Сводка сделок — для партнёров.</div>
    </div>
    <button class="btn" id="shareBtn" style="height:40px">Скопировать ссылку</button>
  </header>

  <div class="tabs" role="tablist">
    <button class="tabBtn active" data-tab="calcTab">Калькулятор</button>
    <button class="tabBtn" data-tab="dealsTab">Сводка сделок</button>
  </div>

  <!-- CALC TAB -->
  <div id="calcTab" class="tabContent" style="display:block;">
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Параметры расчёта</div>
            <div style="font-weight:700;margin-top:4px">Настрой параметры</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Начальный депозит ($)
            <input id="S0" type="number" value="100" min="0" step="1">
          </label>

          <label>Годовая доходность (%) — например 200 = +200%
            <input id="r" type="number" value="200" step="0.1" min="0">
          </label>

          <label>Лет
            <select id="years">
              <option value="3" selected>3</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </label>

          <label>Абонплата (%)
            <div class="fake-input" id="displayFee">10%</div>
            <input id="feePct" type="hidden" value="10">
          </label>

          <label>Порог для взимания абонплаты ($)
            <div class="fake-input" id="displayThreshold">5000$</div>
            <input id="threshold" type="hidden" value="5000">
          </label>

          <label>Потолок абонплаты ($)
            <div class="fake-input" id="displayCap">5000$</div>
            <input id="cap" type="hidden" value="5000">
          </label>

          <div class="row">
            <button class="btn" id="calcBtn">Посчитать</button>
            <button class="btn ghost" id="resetBtn" style="background:#111827">Сброс</button>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="muted">Детализация по годам</div>
          <table id="table">
            <thead><tr><th>Год</th><th>Начало ($)</th><th>После роста ($)</th><th>Абонплата ($)</th><th>Итог ($)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="muted">Краткая сводка</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>
              <div class="muted">Итоговый капитал</div>
              <div id="final" class="result">$0.00</div>
            </div>
            <div style="text-align:right">
              <div class="muted">Общий снятый fee</div>
              <div id="totalFees" style="font-weight:700">$0.00</div>
            </div>
          </div>

          <div class="chartWrap" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">График (Neon TradingView)</div>
              <div class="muted small-muted" id="chartSummary">—</div>
            </div>
            <div class="chartArea" id="chartArea">
              <svg id="chartSvg" width="100%" height="100%" viewBox="0 0 900 360" preserveAspectRatio="none"></svg>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="muted">Примечание</div>
          <div class="muted" style="margin-top:8px;font-size:13px">CLUB500 • Авторская модель Ygnivenko</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEALS TAB -->
  <div id="dealsTab" class="tabContent" style="display:none;">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div style="flex:1">
        <div class="muted" style="font-size:13px">Сводка сделок</div>
        <div style="font-weight:700">Ввод и анализ (точно 20 строк)</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadExcel" style="background:#06b6d4">Скачать Excel</button>
      </div>
    </div>

    <div class="card">
      <p class="small-muted">В одной строке — один актив. Вводи актив и нажимай Enter → получишь тег. Повторный ввод запрещён (покажем сообщение).</p>
      <div style="overflow:auto;margin-top:8px">
        <table id="dealsTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr><th>#</th><th>Актив</th><th>Вход ($)</th><th>Выход ($)</th><th>%</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn" id="calcDealsBtn">Рассчитать доходность</button>
        <button class="btn ghost" id="clearDealsBtn" style="background:#111827">Очистить</button>
        <button class="btn" id="useInCalcBtn" style="background:#06b6d4">Использовать в калькуляторе</button>
      </div>

      <div style="margin-top:16px;display:flex;gap:14px;align-items:center">
        <div>
          <div class="muted">Средняя доходность по сделкам</div>
          <div id="avgDealPct" class="result">0.00%</div>
        </div>
        <div>
          <div class="muted">CAGR (года)</div>
          <div id="cagrDeal" class="result">0.00%</div>
        </div>
      </div>
    </div>
  </div>

  <div style="text-align:center;margin-top:18px"><div class="scanBadge">CLUB500 • Авторская модель Ygnivenko</div></div>
</div>

<script>
/* Helpers */
const $ = id => document.getElementById(id);
const parseSafe = v => { const n = parseFloat(v); return isFinite(n) ? n : 0; };
function money(n){ return '$' + Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

/* Tabs */
document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
    document.getElementById(tab).style.display='block';
    if(tab==='calcTab') recalc();
  });
});

/* Compute */
function compute(params){
  let S = parseSafe(params.S0);
  const r = parseSafe(params.r);
  const years = Math.max(1, Math.floor(parseSafe(params.years)));
  const feePct = parseSafe(params.feePct)/100;
  const threshold = parseSafe(params.threshold);
  const cap = parseSafe(params.cap);
  const rows = []; let totalFees = 0;
  for(let i=1;i<=years;i++){
    const start = S;
    const after = start * (1 + r/100);
    let fee = 0;
    if(after >= threshold) fee = Math.min(after * feePct, cap);
    const end = after - fee;
    rows.push({year:i,start,after,fee,end});
    totalFees += fee; S = end;
  }
  return {rows, final:S, totalFees};
}

/* Draw table and chart (same as before) */
function drawTable(rows){
  const tbody = document.querySelector('#table tbody'); tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="small">${r.year}</td>
                    <td>${money(r.start)}</td>
                    <td>${money(r.after)}</td>
                    <td>${money(r.fee)}</td>
                    <td style="font-weight:700">${money(r.end)}</td>`;
    tbody.appendChild(tr);
  });
}

/* Chart helpers */
function catmullRom2bezier(points){
  const d=[]; for(let i=0;i<points.length-1;i++){
    const p0=points[i-1]||points[i], p1=points[i], p2=points[i+1], p3=points[i+2]||p2;
    d.push([
      p1[0]+(p2[0]-p0[0])/6, p1[1]+(p2[1]-p0[1])/6,
      p2[0]-(p3[0]-p1[0])/6, p2[1]-(p3[1]-p1[1])/6,
      p2[0], p2[1]
    ]);
  } return d;
}
function drawChart(rows){
  const svg = $('chartSvg'); svg.innerHTML=''; const w=900,h=360,pad=50; svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  if(!rows || rows.length===0) return;
  const values = rows.map(r=>r.end); const max=Math.max(...values), min=Math.min(...values); const range=(max-min)||1;
  const pts = rows.map((r,i)=>{ const x=pad+(i/(rows.length-1||1))*(w-pad*2); const y=h-pad-((r.end-min)/range)*(h-pad*2); return [x,y]; });
  let path = `M ${pts[0][0]} ${pts[0][1]}`; if(pts.length>1){ const beziers = catmullRom2bezier(pts); beziers.forEach(b=> path += ` C ${b[0]} ${b[1]}, ${b[2]} ${b[3]}, ${b[4]} ${b[5]}`); }
  const areaD = path + ` L ${pts[pts.length-1][0]} ${h-pad} L ${pts[0][0]} ${h-pad} Z`;
  let grid=''; const rowsGrid=4; for(let i=0;i<=rowsGrid;i++){ const gy = pad + i*((h-pad*2)/rowsGrid); grid += `<line x1="${pad}" x2="${w-pad}" y1="${gy}" y2="${gy}" stroke="rgba(255,255,255,0.03)" stroke-width="1"/>`; }
  const defs = `<defs>
    <linearGradient id="gLine" x1="0" x2="1"><stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#06b6d4"/></linearGradient>
    <linearGradient id="gFill" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#10b981" stop-opacity="0.18"/><stop offset="100%" stop-color="#06b6d4" stop-opacity="0.02"/></linearGradient>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="6" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  </defs>`;
  let dots='', xlabels='', ylabels=''; pts.forEach((p,i)=>{ dots += `<circle cx="${p[0]}" cy="${p[1]}" r="${i===pts.length-1?4:3}" fill="#fff" opacity="${i===pts.length-1?1:0.9}"></circle>`; xlabels += `<text x="${p[0]}" y="${h-pad+18}" font-size="11" fill="${getComputedStyle(document.documentElement).getPropertyValue('--muted')||'#94a3b8'}" text-anchor="middle">${rows[i].year}</text>`; });
  for(let i=0;i<=3;i++){ const val=(max-(i*(range/3))); const gy = pad + (i*((h-pad*2)/3)); ylabels += `<text x="12" y="${gy+4}" font-size="11" fill="${getComputedStyle(document.documentElement).getPropertyValue('--muted')||'#94a3b8'}">${money(val)}</text>`; }
  svg.innerHTML = defs + `<g>${grid}</g><g class="ylabels">${ylabels}</g><g class="xlabels">${xlabels}</g><path d="${areaD}" fill="url(#gFill)" opacity="0.95"></path><g filter="url(#glow)"><path d="${path}" fill="none" stroke="url(#gLine)" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"></path></g><g class="dots">${dots}</g>`;
  $('chartSummary').innerText = `Итог: ${money(rows[rows.length-1].end)}`;
}

/* Recalc */
function recalc(){
  const params = { S0:$('S0').value, r:$('r').value, years:$('years').value, feePct:$('feePct').value, threshold:$('threshold').value, cap:$('cap').value };
  const res = compute(params);
  drawTable(res.rows);
  $('final').innerText = money(res.final);
  $('totalFees').innerText = money(res.totalFees);
  drawChart(res.rows);
  return res;
}

/* Events */
$('calcBtn').addEventListener('click', recalc);
$('resetBtn').addEventListener('click', ()=>{ $('S0').value=4000; $('r').value=200; $('years').value=3; recalc(); });

/* Deals table with single-tag asset per row */
function createDealsTable(){
  const tbody = document.querySelector('#dealsTable tbody');
  tbody.innerHTML='';
  for(let i=1;i<=20;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="small">${i}</td>
      <td style="text-align:left">
        <div class="tagWrap" data-row="${i}">
          <span class="tagDisplay" style="display:none"></span>
          <input type="text" class="assetEntry" placeholder="введите актив (нажмите Enter)" />
        </div>
      </td>
      <td><input class="deals-input in" type="number" step="0.01" /></td>
      <td><input class="deals-input out" type="number" step="0.01" /></td>
      <td class="small deal-pct">0%</td>`;
    tbody.appendChild(tr);
  }

  // add listeners for entries
  document.querySelectorAll('.tagWrap').forEach(w=>{
    const input = w.querySelector('.assetEntry');
    const display = w.querySelector('.tagDisplay');
    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const val = input.value.trim();
        if(!val) return;
        if(display.innerText.trim() !== '') {
          // already has a tag
          alert('В сделке может быть только один актив');
          input.value = '';
          return;
        }
        const up = val.toUpperCase();
        display.innerHTML = `<span class="tagText">${up}</span><button class="remove" title="удалить">✕</button>`;
        display.style.display = 'inline-flex';
        input.style.display = 'none';
        // remove handler
        display.querySelector('.remove').addEventListener('click', ()=>{
          display.innerHTML = '';
          display.style.display = 'none';
          input.style.display = 'inline-block';
          input.value = '';
          input.focus();
        });
      }
    });
  });
}
createDealsTable();

/* Calc deals */
document.getElementById('calcDealsBtn').addEventListener('click', ()=>{
  const ins = Array.from(document.querySelectorAll('.in')).map(x=>parseSafe(x.value));
  const outs = Array.from(document.querySelectorAll('.out')).map(x=>parseSafe(x.value));
  const pctCells = document.querySelectorAll('.deal-pct');
  const assets = Array.from(document.querySelectorAll('.tagWrap')).map(t=>{
    const disp = t.querySelector('.tagDisplay');
    const txt = disp && disp.querySelector('.tagText') ? disp.querySelector('.tagText').innerText : '';
    return txt;
  });
  const pcts=[];
  for(let i=0;i<ins.length;i++){
    const iVal = ins[i], oVal = outs[i];
    if(iVal>0 && oVal>0){
      const pct = (oVal / iVal - 1) * 100;
      pctCells[i].innerText = pct.toFixed(2) + '%';
      pcts.push(pct);
    } else {
      pctCells[i].innerText = '0%';
    }
  }
  const avg = pcts.length ? pcts.reduce((a,b)=>a+b,0)/pcts.length : 0;
  $('avgDealPct').innerText = avg.toFixed(2) + '%';

  // CAGR: first non-empty in / last non-empty out (periods = index difference or 1)
  const insArr = ins, outsArr = outs;
  const firstIdx = insArr.findIndex(v=>v>0);
  let lastIdx = -1;
  for(let i=outsArr.length-1;i>=0;i--){ if(outsArr[i]>0){ lastIdx = i; break; } }
  let cagr = 0;
  if(firstIdx >= 0 && lastIdx > firstIdx){
    const startVal = insArr[firstIdx]; const endVal = outsArr[lastIdx]; const periods = Math.max(1, lastIdx - firstIdx);
    cagr = (Math.pow(endVal / Math.max(1,startVal), 1/periods) - 1) * 100;
  }
  $('cagrDeal').innerText = isFinite(cagr) ? cagr.toFixed(2) + '%' : '0.00%';
});

/* Clear deals */
$('clearDealsBtn').addEventListener('click', ()=>{
  document.querySelectorAll('.in').forEach(i=>i.value='');
  document.querySelectorAll('.out').forEach(i=>i.value='');
  document.querySelectorAll('.deal-pct').forEach(d=>d.innerText='0%');
  document.querySelectorAll('.tagDisplay').forEach(d=>{ d.innerHTML=''; d.style.display='none'; d.parentElement.querySelector('.assetEntry').style.display='inline-block'; });
  $('avgDealPct').innerText='0.00%'; $('cagrDeal').innerText='0.00%';
});

/* Use avg in calc */
$('useInCalcBtn').addEventListener('click', ()=>{
  const avgText = $('avgDealPct').innerText || '0%';
  const avg = parseFloat(avgText.replace('%','')) || 0;
  $('r').value = avg.toFixed(2);
  alert('Средняя доходность добавлена в поле "Годовая доходность (%)".');
  // switch to calc tab
  document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.tabBtn[data-tab="calcTab"]').classList.add('active');
  document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
  document.getElementById('calcTab').style.display='block';
  recalc();
});

/* Copy link */
$('shareBtn').addEventListener('click', ()=>{
  const params = new URLSearchParams({ S0:$('S0').value, r:$('r').value, years:$('years').value, feePct:$('feePct').value, threshold:$('threshold').value, cap:$('cap').value });
  const link = location.href.split('?')[0] + '?' + params.toString();
  navigator.clipboard.writeText(link).then(()=> alert('Ссылка скопирована в буфер обмена'));
});

/* Generate Excel (SpreadsheetML) with Asset column */
function generateExcelXml(){
  const ins = Array.from(document.querySelectorAll('.in')).map(x=>parseSafe(x.value));
  const outs = Array.from(document.querySelectorAll('.out')).map(x=>parseSafe(x.value));
  const assets = Array.from(document.querySelectorAll('.tagWrap')).map(t=>{ const d=t.querySelector('.tagDisplay'); return d && d.querySelector('.tagText')? d.querySelector('.tagText').innerText : ''; });
  const rows=[];
  for(let i=0;i<ins.length;i++){
    if(assets[i] || ins[i] || outs[i]) rows.push({asset:assets[i], in:ins[i], out:outs[i], pct:(ins[i]>0 && outs[i]>0)?((outs[i]/ins[i]-1)*100):0});
  }
  const avg = rows.length ? (rows.reduce((s,r)=>s + r.pct,0)/rows.length) : 0;
  let cagr = 0;
  if(rows.length >= 2){
    const first = rows.find(r=>r.in>0);
    const last = [...rows].reverse().find(r=>r.out>0);
    if(first && last){
      const start = first.in, end = last.out, periods = Math.max(1, rows.indexOf(last) - rows.indexOf(first) || 1);
      cagr = (Math.pow(end / Math.max(1,start), 1/periods) - 1) * 100;
    }
  }

  const header = `<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">`;
  const styles = `<Styles><Style ss:ID="h"><Font ss:Bold="1" ss:Color="#ffffff"/></Style><Style ss:ID="money"><NumberFormat ss:Format="\\u0022$\\u0022#,##0.00"/></Style></Styles>`;
  let dealsRows = `<Row><Cell ss:StyleID="h"><Data ss:Type="String">#</Data></Cell><Cell ss:StyleID="h"><Data ss:Type="String">Актив</Data></Cell><Cell ss:StyleID="h"><Data ss:Type="String">Вход ($)</Data></Cell><Cell ss:StyleID="h"><Data ss:Type="String">Выход ($)</Data></Cell><Cell ss:StyleID="h"><Data ss:Type="String">Доходность %</Data></Cell></Row>`;
  rows.forEach((r,i)=>{ dealsRows += `<Row><Cell><Data ss:Type="Number">${i+1}</Data></Cell><Cell><Data ss:Type="String">${r.asset}</Data></Cell><Cell ss:StyleID="money"><Data ss:Type="Number">${r.in}</Data></Cell><Cell ss:StyleID="money"><Data ss:Type="Number">${r.out}</Data></Cell><Cell><Data ss:Type="Number">${r.pct.toFixed(4)}</Data></Cell></Row>`; });
  const dealsSheet = `<Worksheet ss:Name="Deals"><Table>${dealsRows}</Table></Worksheet>`;
  const summaryRows = `<Row><Cell ss:StyleID="h"><Data ss:Type="String">Показатель</Data></Cell><Cell ss:StyleID="h"><Data ss:Type="String">Значение</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Средняя доходность (%)</Data></Cell><Cell><Data ss:Type="Number">${avg.toFixed(4)}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">CAGR (%)</Data></Cell><Cell><Data ss:Type="Number">${cagr.toFixed(4)}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Исходный депозит ($)</Data></Cell><Cell ss:StyleID="money"><Data ss:Type="Number">${parseSafe($('S0').value)}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Годовая доходность (%)</Data></Cell><Cell><Data ss:Type="Number">${parseSafe($('r').value).toFixed(4)}</Data></Cell></Row>`;
  const summarySheet = `<Worksheet ss:Name="Summary"><Table>${summaryRows}</Table></Worksheet>`;
  const xml = header + styles + dealsSheet + summarySheet + `</Workbook>`;
  return xml;
}

$('downloadExcel').addEventListener('click', ()=>{
  const xml = generateExcelXml();
  const blob = new Blob([xml],{type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'club500_deals.xlsx'; a.click(); URL.revokeObjectURL(url);
});

/* Load from params */
(function loadFromParams(){
  const p = new URLSearchParams(location.search);
  if(p.has('S0')) $('S0').value = p.get('S0');
  if(p.has('r')) $('r').value = p.get('r');
  if(p.has('years')) $('years').value = p.get('years');
  recalc();
})();

/* Responsive redraw */
let resizeTimer; window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer = setTimeout(()=> recalc(),160); });

/* Init */
recalc();
</script>
</body>
</html>

